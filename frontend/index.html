<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Resumen de PDF (mínimo)</title>
    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            line-height: 1.5;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            cursor: pointer;
        }

        textarea {
            width: 100%;
        }

        input[type="file"] {
            margin: 10px 0;
        }

        .muted {
            color: #666;
            font-size: 0.9em;
        }

        pre {
            white-space: pre-wrap;
        }
    </style>

    <!-- pdf.js v2.x que expone pdfjsLib en window -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
    <script>
        // Configura el worker (debe coincidir con la versión de arriba)
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>
</head>

<body>
    <h1>Resumen de PDF (≤ 500 caracteres)</h1>

    <div class="card">
        <h2>1) Elegí un PDF</h2>
        <input id="fileInput" type="file" accept="application/pdf" />
        <div>
            <label>API Base URL:</label>
            <input id="apiBase" size="60" placeholder="https://jh0l16klcc.execute-api.us-east-1.amazonaws.com" />
        </div>
        <button id="btnSummarize">Resumir</button>
        <p id="status" class="muted"></p>
    </div>

    <div class="card">
        <h2>2) Resumen</h2>
        <pre id="summary">—</pre>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const apiBase = document.getElementById('apiBase');
        const statusEl = document.getElementById('status');
        const summaryEl = document.getElementById('summary');

        async function extractTextFromPDF(file) {
            const buf = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
            let out = '';
            for (let p = 1; p <= pdf.numPages; p++) {
                const page = await pdf.getPage(p);
                const content = await page.getTextContent();
                const text = content.items.map(i => i.str).join(' ');
                out += text + '\n';
                if (out.length > 30000) break; // límite de seguridad
            }
            return out.trim();
        }

        document.getElementById('btnSummarize').onclick = async () => {
            statusEl.textContent = '';
            summaryEl.textContent = '—';

            const file = fileInput.files?.[0];
            const base = apiBase.value.trim();
            if (!file) { statusEl.textContent = 'Elegí un PDF primero.'; return; }
            if (!base) { statusEl.textContent = 'Pegá el API Base URL.'; return; }

            try {
                statusEl.textContent = 'Extrayendo texto del PDF en el navegador...';
                const text = await extractTextFromPDF(file);
                if (!text) { summaryEl.textContent = 'No se pudo extraer contenido.'; return; }

                statusEl.textContent = 'Llamando a la API para resumir...';
                const res = await fetch(`${base}/summarize`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Error en la API');

                summaryEl.textContent = data.summary || 'Sin respuesta';
                statusEl.textContent = 'Listo ✔';
            } catch (e) {
                statusEl.textContent = 'Error: ' + e.message;
            }
        };
    </script>
</body>

</html>